configs = [
    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "network",
        "GAME_WIDTH": 5, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 20, "cpus": 32, "seeds": "0-14",
    },
    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "network",
        "GAME_WIDTH": 6, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 20, "cpus": 32, "seeds": "0-14",
    },
    # {
    #     "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "network",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 30, "cpus": 32, "seeds": "0-14",
    # },
    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "network",
        "GAME_WIDTH": 7, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 300000,
        "minutes": 30, "cpus": 32, "seeds": "0-14",
    },
    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "network",
        "GAME_WIDTH": 7, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 300000,
        "minutes": 30, "cpus": 32, "seeds": "0-14",
    },
    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "input",
        "GAME_WIDTH": 5, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 20, "cpus": 32, "seeds": "0-14",
    },
    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "input",
        "GAME_WIDTH": 6, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 20, "cpus": 32, "seeds": "0-14",
    },
    # {
    #     "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "input",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 30, "cpus": 32, "seeds": "0-14",
    # },
    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "input",
        "GAME_WIDTH": 7, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 300000,
        "minutes": 30, "cpus": 32, "seeds": "0-14",
    },
    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "input",
        "GAME_WIDTH": 7, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 300000,
        "minutes": 30, "cpus": 32, "seeds": "0-14",
    },
    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "both",
        "GAME_WIDTH": 5, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 20, "cpus": 32, "seeds": "0-14",
    },
    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "both",
        "GAME_WIDTH": 6, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 20, "cpus": 32, "seeds": "0-14",
    },
    # {
    #     "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "both",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 30, "cpus": 32, "seeds": "0-14",
    # },
    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "both",
        "GAME_WIDTH": 7, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 300000,
        "minutes": 30, "cpus": 32, "seeds": "0-14",
    },
    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "both",
        "GAME_WIDTH": 7, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 300000,
        "minutes": 30, "cpus": 32, "seeds": "0-14",
    },

    {
        "MODE": "train_option", "TMP_OPT": "FineTune", "MASK_TYPE": "",
        "GAME_WIDTH": 5, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 20, "cpus": 32, "seeds": "0-14",
    },
    {
        "MODE": "train_option", "TMP_OPT": "FineTune", "MASK_TYPE": "",
        "GAME_WIDTH": 6, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 20, "cpus": 32, "seeds": "0-14",
    },
    # {
    #     "MODE": "train_option", "TMP_OPT": "FineTune", "MASK_TYPE": "",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 30, "cpus": 32, "seeds": "0-14",
    # },
    {
        "MODE": "train_option", "TMP_OPT": "FineTune", "MASK_TYPE": "",
        "GAME_WIDTH": 7, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 300000,
        "minutes": 30, "cpus": 32, "seeds": "0-14",
    },
    {
        "MODE": "train_option", "TMP_OPT": "FineTune", "MASK_TYPE": "",
        "GAME_WIDTH": 7, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 300000,
        "minutes": 30, "cpus": 32, "seeds": "0-14",
    },

    {
        "MODE": "train_option", "TMP_OPT": "DecWhole", "MASK_TYPE": "",
        "GAME_WIDTH": 5, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 20, "cpus": 8, "seeds": "0-14",
    },
    {
        "MODE": "train_option", "TMP_OPT": "DecWhole", "MASK_TYPE": "",
        "GAME_WIDTH": 6, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 20, "cpus": 8, "seeds": "0-14",
    },
    # {
    #     "MODE": "train_option", "TMP_OPT": "DecWhole", "MASK_TYPE": "",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 30, "cpus": 8, "seeds": "0-14",
    # },
    {
        "MODE": "train_option", "TMP_OPT": "DecWhole", "MASK_TYPE": "",
        "GAME_WIDTH": 7, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 300000,
        "minutes": 30, "cpus": 8, "seeds": "0-14",
    },
    {
        "MODE": "train_option", "TMP_OPT": "DecWhole", "MASK_TYPE": "",
        "GAME_WIDTH": 7, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 300000,
        "minutes": 30, "cpus": 8, "seeds": "0-14",
    },

    {
        "MODE": "train_option", "TMP_OPT": "Transfer", "MASK_TYPE": "",
        "GAME_WIDTH": 5, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 20, "cpus": 4, "seeds": "0-14",
    },
    {
        "MODE": "train_option", "TMP_OPT": "Transfer", "MASK_TYPE": "",
        "GAME_WIDTH": 6, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 20, "cpus": 4, "seeds": "0-14",
    },
    # {
    #     "MODE": "train_option", "TMP_OPT": "Transfer", "MASK_TYPE": "",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 30, "cpus": 4, "seeds": "0-14",
    # },
    {
        "MODE": "train_option", "TMP_OPT": "Transfer", "MASK_TYPE": "",
        "GAME_WIDTH": 7, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 300000,
        "minutes": 30, "cpus": 4, "seeds": "0-14",
    },
    {
        "MODE": "train_option", "TMP_OPT": "Transfer", "MASK_TYPE": "",
        "GAME_WIDTH": 7, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 300000,
        "minutes": 30, "cpus": 4, "seeds": "0-14",
    },
 
]

configs = [
    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "network",
        "GAME_WIDTH": 5, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 45, "cpus": 32, "seeds": "0-14",
    },
    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "network",
        "GAME_WIDTH": 6, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 45, "cpus": 32, "seeds": "0-14",
    },
    # {
    #     "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "network",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 30, "cpus": 32, "seeds": "0-14",
    # },
    # {
    #     "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "network",
    #     "GAME_WIDTH": 7, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 300000,
    #     "minutes": 45, "cpus": 32, "seeds": "0-14",
    # },
    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "network",
        "GAME_WIDTH": 7, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 300000,
        "minutes": 45, "cpus": 32, "seeds": "0-14",
    },
    
    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "input",
        "GAME_WIDTH": 5, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 45, "cpus": 32, "seeds": "0-14",
    },
    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "input",
        "GAME_WIDTH": 6, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 45, "cpus": 32, "seeds": "0-14",
    },
    # {
    #     "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "input",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 30, "cpus": 32, "seeds": "0-14",
    # },
    # {
    #     "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "input",
    #     "GAME_WIDTH": 7, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 300000,
    #     "minutes": 30, "cpus": 32, "seeds": "0-14",
    # },
    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "input",
        "GAME_WIDTH": 7, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 300000,
        "minutes": 45, "cpus": 32, "seeds": "0-14",
    },

    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "both",
        "GAME_WIDTH": 5, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 45, "cpus": 32, "seeds": "0-14",
    },
    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "both",
        "GAME_WIDTH": 6, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 45, "cpus": 32, "seeds": "0-14",
    },
    # {
    #     "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "both",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 30, "cpus": 32, "seeds": "0-14",
    # },
    # {
    #     "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "both",
    #     "GAME_WIDTH": 7, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 300000,
    #     "minutes": 30, "cpus": 32, "seeds": "0-14",
    # },
    {
        "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "both",
        "GAME_WIDTH": 7, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 300000,
        "minutes": 45, "cpus": 32, "seeds": "0-14",
    },

    {
        "MODE": "train_option", "TMP_OPT": "FineTune", "MASK_TYPE": "",
        "GAME_WIDTH": 5, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 45, "cpus": 32, "seeds": "0-14",
    },
    {
        "MODE": "train_option", "TMP_OPT": "FineTune", "MASK_TYPE": "",
        "GAME_WIDTH": 6, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 45, "cpus": 32, "seeds": "0-14",
    },
    # {
    #     "MODE": "train_option", "TMP_OPT": "FineTune", "MASK_TYPE": "",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 30, "cpus": 32, "seeds": "0-14",
    # },
    # {
    #     "MODE": "train_option", "TMP_OPT": "FineTune", "MASK_TYPE": "",
    #     "GAME_WIDTH": 7, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 300000,
    #     "minutes": 30, "cpus": 32, "seeds": "0-14",
    # },
    {
        "MODE": "train_option", "TMP_OPT": "FineTune", "MASK_TYPE": "",
        "GAME_WIDTH": 7, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 300000,
        "minutes": 45, "cpus": 32, "seeds": "0-14",
    },

 
]

# GW6 H64
configs = [
    
    # {
    #     "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "network",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 60, "cpus": 32, "seeds": "0-12,14",
    # },
    
    # {
    #     "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "input",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 60, "cpus": 32, "seeds": "0-12,14",
    # },
    
    # {
    #     "MODE": "train_option", "TMP_OPT": "Mask", "MASK_TYPE": "both",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 90, "cpus": 32, "seeds": "12",
    # },
    
    {
        "MODE": "train_option", "TMP_OPT": "FineTune", "MASK_TYPE": "",
        "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
        "minutes": 90, "cpus": 32, "seeds": "8",
    },
    
    # {
    #     "MODE": "train_option", "TMP_OPT": "DecWhole", "MASK_TYPE": "",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 20, "cpus": 8, "seeds": "0-12,14",
    # },
    
    # {
    #     "MODE": "train_option", "TMP_OPT": "Transfer", "MASK_TYPE": "",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 10, "cpus": 4, "seeds": "0-12,14",
    # },

 
]


configs2 = [
    
    # {
    #     "MODE": "tune", "TMP_OPT": "Mask", "MASK_TYPE": "network",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 30, "cpus": 4, "seeds": "1",
    # },
    
    # {
    #     "MODE": "tune", "TMP_OPT": "Mask", "MASK_TYPE": "input",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 30, "cpus": 4, "seeds": "1",
    # },
    
    # {
    #     "MODE": "tune", "TMP_OPT": "Mask", "MASK_TYPE": "both",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 30, "cpus": 4, "seeds": "1",
    # },
    
    {
        "MODE": "tune", "TMP_OPT": "FineTune", "MASK_TYPE": "",
        "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
        "minutes": 30, "cpus": 4, "seeds": "1",
    },
    
    # {
    #     "MODE": "tune", "TMP_OPT": "DecWhole", "MASK_TYPE": "",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 30, "cpus": 4, "seeds": "1",
    # },
    
    # {
    #     "MODE": "tune", "TMP_OPT": "Transfer", "MASK_TYPE": "",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 30, "cpus": 4, "seeds": "1",
    # },

 
]


# GW6 H64
configs = [
    # {
    #     "MODE": "test", "TMP_OPT": "", "MASK_TYPE": "",
    #     "GAME_WIDTH": 5, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
    #     "minutes": 10, "cpus": 4, "seeds": "15-59", "STEP_SIZE": 0.003
    # },

    {
        "MODE": "test", "TMP_OPT": "", "MASK_TYPE": "",
        "GAME_WIDTH": 5, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 100000,
        "minutes": 10, "cpus": 4, "seeds": "0-59", "STEP_SIZE": 0.003
    },
    {
        "MODE": "test", "TMP_OPT": "", "MASK_TYPE": "",
        "GAME_WIDTH": 6, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 200000,
        "minutes": 10, "cpus": 4, "seeds": "15-59", "STEP_SIZE": 0.003
    },

    # {
    #     "MODE": "test", "TMP_OPT": "", "MASK_TYPE": "",
    #     "GAME_WIDTH": 6, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 200000,
    #     "minutes": 10, "cpus": 4, "seeds": "15-59", "STEP_SIZE": 0.003
    # },
    {
        "MODE": "test", "TMP_OPT": "", "MASK_TYPE": "",
        "GAME_WIDTH": 7, "HIDDEN_SIZE": 6, "TOTAL_STEPS": 300000,
        "minutes": 10, "cpus": 4, "seeds": "0-59", "STEP_SIZE": 0.003
    },

    {
        "MODE": "test", "TMP_OPT": "", "MASK_TYPE": "",
        "GAME_WIDTH": 7, "HIDDEN_SIZE": 64, "TOTAL_STEPS": 300000,
        "minutes": 10, "cpus": 4, "seeds": "0-59", "STEP_SIZE": 0.003
    },
    
]


import subprocess


import os
import random
import string
from pathlib import Path
import subprocess


original_cwd = os.getcwd()

for cfg in configs:
    # Base directory
    base_dir = f"./combogrid_gw{cfg['GAME_WIDTH']}_h{cfg['HIDDEN_SIZE']}/_steps={cfg['TOTAL_STEPS']}"
    subfolder = f"{cfg['TMP_OPT']}_{cfg['MASK_TYPE']}".rstrip('_')
    full_base_path = Path(base_dir) / subfolder

    # Find next available v{idx} directory
    idx = 0
    while (full_base_path / f"{cfg['MODE']}/v{idx}").exists():
        idx += 1
    final_dir = full_base_path / f"{cfg['MODE']}/v{idx}"
    final_dir.mkdir(parents=True)

    # Change working directory
    os.chdir(final_dir)

    if any([mode in cfg['MODE'] for mode in ['train', 'test', 'tune_base_model']]):
        if "tune_base_model" in cfg['MODE']:
            cfg['MODE'] = cfg['MODE'].replace('tune_base_model', "tune")
        script = f"""#!/usr/bin/env bash
#SBATCH --job-name={cfg['MODE']}_gw{cfg['GAME_WIDTH']}_h{cfg['HIDDEN_SIZE']}_{cfg['TMP_OPT']}_{cfg['MASK_TYPE']}
#SBATCH --time=0-00:{cfg['minutes']}:00
#SBATCH --mem=1G
#SBATCH --cpus-per-task={cfg['cpus']}
#SBATCH --account=rrg-lelis
#SBATCH --array={cfg['seeds']}  # 58,59  # 2,6,7,12,15,19,20,21,23,26,30,31,32,34,35,38,39    # 0-11  
#SBATCH --output=logs/exp_%A_%a.out
#SBATCH --error=logs/exp_%A_%a.err

set -euo pipefail

# Move into repo
cd /home/rezaabdz/projects/def-lelis/rezaabdz/neurips-2025-paper-neural-decomposition

# Load modules & env
module load StdEnv/2020 gcc flexiblas python/3.10 mujoco/2.3.6
source /home/rezaabdz/scratch/envs/venv2/bin/activate

# Pin BLAS/OpenMP
export OMP_NUM_THREADS=1
export MKL_NUM_THREADS=1
export OPENBLAS_NUM_THREADS=1
export PYTHONUNBUFFERED=1
export FLEXIBLAS=imkl

# Compute array‐task index
IDX=$SLURM_ARRAY_TASK_ID   # 1…59

# Map to agent‐seed (0…14) and env‐seed (0…3)
AGENT_IDX=$(( (IDX) / 4 ))
export SEED=$(( AGENT_IDX * 1 ))
export ENV_SEED=$(( (IDX) % 4 ))
# export TMP_SEED=$(( AGENT_IDX * 1000 )) 

# AGENT_IDX=$((IDX))
# export ENV_SEED=12

export GAME_WIDTH={cfg['GAME_WIDTH']}
export HIDDEN_SIZE={cfg['HIDDEN_SIZE']}
export TOTAL_STEPS={cfg['TOTAL_STEPS']}
export MODE="{cfg['MODE']}"
export STEP_SIZE={cfg.get('STEP_SIZE', 0.0003)}


echo "STEP_SIZE: $((STEP_SIZE))"
echo "TOTAL_STEPS: $((TOTAL_STEPS))"

# Run your script (it should read both $SEED and $ENV_SEED from os.environ)
python -u main.py --config_path configs/combogrid/config_a2c_train.py"""
    else:
        if "tune_option" in cfg['MODE']:
            cfg['MODE'] = cfg['MODE'].replace('tune_option', "tune")
        script = f"""#!/usr/bin/env bash
#SBATCH --job-name={cfg['MODE']}_gw{cfg['GAME_WIDTH']}_h{cfg['HIDDEN_SIZE']}_{cfg['TMP_OPT']}_{cfg['MASK_TYPE']}
#SBATCH --time=0-00:{cfg['minutes']}:00
#SBATCH --mem-per-cpu=1G
#SBATCH --cpus-per-task={cfg['cpus']}
#SBATCH --account=rrg-lelis
#SBATCH --array={cfg['seeds']}
#SBATCH --output=logs/exp_%A_%a.out
#SBATCH --error=logs/exp_%A_%a.err

set -euo pipefail

# Move into repo
cd /home/rezaabdz/projects/def-lelis/rezaabdz/neurips-2025-paper-neural-decomposition

# Load modules & env
module load StdEnv/2020 gcc flexiblas python/3.10 mujoco/2.3.6
source /home/rezaabdz/scratch/envs/venv2/bin/activate

# Pin BLAS/OpenMP
export OMP_NUM_THREADS=1
export MKL_NUM_THREADS=1
export OPENBLAS_NUM_THREADS=1
export PYTHONUNBUFFERED=1
export FLEXIBLAS=imkl

# Compute array‐task index
IDX=$SLURM_ARRAY_TASK_ID   # 1…300

# Map to agent‐seed (0…14) and env‐seed (0…3)
# AGENT_IDX=$(( (IDX) / 4 ))
export SEED=$((IDX))
export ENV_SEED={cfg.get('ENV_SEED', 12)}
export NAMETAG='env_$((ENV_SEED))'

export GAME_WIDTH={cfg['GAME_WIDTH']}
export HIDDEN_SIZE={cfg['HIDDEN_SIZE']}
export MASK_TYPE="{cfg['MASK_TYPE']}"
export TMP_OPT="{cfg['TMP_OPT']}" # Mask, FineTune, DecWhole, Transfer, DecOption

# Testing/Training option arguments
export TOTAL_STEPS={cfg['TOTAL_STEPS']}

# Testing arguments
export STEP_SIZE={cfg.get('STEP_SIZE', 0.0003)}

export MODE="{cfg['MODE']}" # train, test, plot, tune, train_option, test_option, search_option

# Run your script (it should read both $SEED and $ENV_SEED from os.environ)
python -u main.py --config_path /home/rezaabdz/projects/def-lelis/rezaabdz/neurips-2025-paper-neural-decomposition/configs/combogrid/config_a2c_option.py
"""

    with open("job.slurm", "w") as f:
        f.write(script)

    # Optional: Run your command here (e.g., echo test)
    print(f"Running command in {final_dir.resolve()}")
    subprocess.run(["sbatch", "job.slurm"])

    # Change directory back to original to continue loop
    os.chdir(original_cwd)  # Adjust based on depth